{
  "name": "Prairie-ultima-iv-image-batch-processing",
  "tagline": "FIJI/ImageJ Macro for sorting batches of stacks acquired with Praire Ultima IV two-photon microscopes.",
  "body": "# Prairie-Ultima-IV-image-batch-processing\r\nFIJI/ImageJ Macro for sorting batch of stacks acquired from Praire Ultima IV two-photon microscopes.\r\n\r\nThe macro is needed to sort the stack of images acquired with Praire Ultima IV systems into a useful set of data to be visualised with TrackEM2 FIJI plugin.\r\n\r\nTo use it simply copy the file into /macro subfolder and install it via the macro drop down menu option \"install\".\r\n\r\nThis macro batch processes all the files in a folder and any subfolders in that folder. Use it to process a session/timepoint (_a, _b, etc.). It saves its output in two subfolders called \"Processed_Max_Projections\" and \"Stitching_ready_tiffs\" (divided into four zoom subfolders, 40x only). It gets the filename, x, y and z coordinates (together with some other values) from the .xml metadata file in the ROI subfolder and stores these values as a comma separated list text file named \"CoordinatesZ(n).txt\" in each zoom folder. It  saves the single plane images sequentially, makes the MAX projection, converts all to 8-bit and finally saves them. The dialog at the beginning sets wether to run the StackReg plugin to align the images in the stack and/or to filter them (Median filter pixel value 1). \r\n\r\nThe vesion 5 does not write the ROI number at the four corners leaving the images unaltered. Please refer to the \"How to use Stitching macro.txt\" file for a guide on how to use the output of this macro to get 3D mosaics.\r\n\r\nThe version 6 also writes the zoom value and the ROI number at the four corners of the images ready to be stitched. Please note that it actually draws these information on the image, so in this extent it is \"destructive\" macro.\r\n\r\nPlease refer to the \"How to use Stitching macro.txt\" file for a guide on how to use the output of this macro to get 3D mosaics.\r\n\r\n#Here is the code to be copy-pasted to your macro file(s):\r\n\r\n    macro \"Nostromo no ROI number version\" { \r\n\r\n    /* \"Batch MAX Align and Process Folders and Subfolders\" Antonio Trabalza - MRC - 2015\r\n\r\n    Refer to the individual macro file for more info.\r\n\r\n    For other kinds of processing,\r\n    edit the processFile() function at the end of this macro.*/\r\n   \r\n       // requires(\"1.44e\"); // classic ImageJ compatibility.\r\n       if (nImages() > 0) exit(\"ERROR ! Before starting, please close all image windows !\");\r\n       // Checks that no image windows are open.\r\n       srcDir = getDirectory(\"Choose a Directory \");\r\n       trgDir = srcDir + \"Stitching_ready_tiffs\";\r\n       trgDir2 = srcDir + \"Processed_MAX_Projections\";\r\n       if (File.exists(trgDir) || (trgDir2))\r\n       exit(\"ERROR ! Destination directories already exist; if you really want, remove them and then run this macro again\"); \r\n       File.makeDirectory(trgDir);\r\n       File.makeDirectory(trgDir2);   \r\n       setBatchMode(true);\r\n       run(\"Bio-Formats Macro Extensions\");\r\n       Dialog.create(\"Options\");\r\n       Dialog.addCheckbox(\"StackReg\", true);\r\n       Dialog.addCheckbox(\"Median Filter\", true);\r\n       Dialog.show();\r\n       align = Dialog.getCheckbox();\r\n       filter = Dialog.getCheckbox();\r\n       count = 0;\r\n       countFiles(srcDir);\r\n       n = 0;\r\n       processFiles(srcDir);\r\n       //print(count+\" files processed\");\r\n   \r\n       function countFiles(srcDir) {\r\n           list = getFileList(srcDir);\r\n           for (i=0; i<list.length; i++) {\r\n               if (endsWith(list[i], File.separator))\r\n                   countFiles(\"\"+srcDir+list[i]);\r\n               else\r\n                   count++;\r\n           }\r\n       }\r\n    \r\n       function processFiles(srcDir) {\r\n           list = getFileList(srcDir);\r\n           for (i=0; i<list.length; i++) {\r\n              if (endsWith(list[i], File.separator))\r\n                  processFiles(\"\"+srcDir+list[i]);\r\n              else {\r\n                 showProgress(n++, count);\r\n                 path = srcDir+list[i];\r\n                 processFile(path);\r\n              }\r\n           }\r\n       }\r\n      \r\n       function processFile(path) {\r\n           \r\n       // zoom value is stored in row 57 as per \"1\", \"2\", etc. \t\r\n       // Zoom 1 = microns per pixels: 0.588235294117647\r\n       // Zoom 2 = microns per pixels: 0.294067245037119\r\n       // Zoom 3 = microns per pixels: 0.196038609069362\r\n       // Zoom 4 = microns per pixels: 0.147027323885178\r\n         \r\n           if (endsWith(path, \".ome.tif\")) {\r\n               id = File.getName(path); \r\n\t       newMAXname = \"MAX_\" + substring(id,0,indexOf(id,\"_Cycle\"))+\".tif\";\r\n\t       ROIname = substring(id,(lastIndexOf(id,\"-0\")+2),indexOf(id,\"_Cycle\"));\r\n\t       //newMAXname =\"MAX_\" + substring(id,0,lastIndexOf(id,\".xml\")) +\".tif\";\r\n\t     \r\n\t       if (!File.exists(trgDir2 + File.separator + newMAXname ) && !File.exists(trgDir + File.separator + id) {\r\n\t           run(\"Bio-Formats Importer\", \"open=[\" + path + \"] color_mode=Default open_all_series view=[Standard ImageJ] stack_order=Default\");\r\n\t   \t   //run(\"Image Sequence...\", \"open=[\" + path + \"] number=count starting=1 increment=1 scale=100 file=[] or=[] sort\");\r\n\t       if(nSlices > 1){\r\n\t           if (align==true) run(\"StackReg\", \"transformation=[Rigid Body]\"); // for classic ImageJ compatibility add a space after StackReg.\r\n\t\t    \r\n            // Uses Bio-Formats to print the chosen file's metadata to the Log.\r\n\r\n    \t    // !!!!!IMPORTANT!!!!!\r\n\t    // It DOESN'T work with Bio-Formats versions 5.1.0 and 5.1.1 !!!\r\n\t    // Use either 5.0.8 or 5.1.2 (relased 28 May 2015).\r\n\r\n\t   \t    Ext.setId(path);\r\n\t\t    Ext.getImageCount(imageCount);\r\n\t\t    positionX = newArray(imageCount);\r\n\t\t    positionY = newArray(imageCount);\r\n\t\t    positionZ = newArray(imageCount);\r\n\t\t    used_path = newArray(imageCount);\r\n\t\t  \t    \t  \r\n\t\t    Ext.getPixelsPhysicalSizeX(pxsize); //Gets the microns per pixels value.\r\n  \t\t  \r\n\t\t    //px=toString(pxsize,9); // (DEBUG) max usable decimal positions. \r\n\t\t    //print(px);\r\n\t\t    //pxf = parseFloat(px);\r\n\t\t  \r\n\t\t    zoomDir = newArray(\"Zoom1\", \"Zoom2\", \"Zoom3\", \"Zoom4+\");\r\n\t\t    for (z=0; z<zoomDir.length; z++) {\r\n\t\t        if (!File.exists(trgDir + File.separator + zoomDir[z]))\r\n\t\t            File.makeDirectory(trgDir + File.separator + zoomDir[z]);\r\n\t            }\r\n\t\t    for (no=0; no<imageCount; no++) {\r\n  \t  \t        Ext.getSizeX(sizeX);\r\n\t\t\tExt.getSizeY(sizeY);\r\n\t\t\tExt.getPlanePositionX(positionX[no], no);\r\n  \t  \t\tExt.getPlanePositionY(positionY[no], no);\r\n  \t  \t\tExt.getPlanePositionZ(positionZ[no], no);\r\n  \t  \t\tpixsX = (positionX[no]/pxsize); // Conversion of the micron coordinates in pixel coordinates.\r\n  \t  \t\t//invY = (positionY[no] * -1); // Inversion of coordinates.\r\n  \t  \t\tinv_pixsY = ((positionY[no]/pxsize)* -1); // Conversion and Inversion.\r\n  \t  \t\tr_pixsZ = round((positionZ[no]/pxsize)); // Rounding and Conversion.\r\n  \t  \t\t//round_Z = round(positionZ[no]); // Rounding.\r\n  \t  \t\t\r\n  \t  \t\tExt.getUsedFile(no, used_path[no]); // Gets the no'th filename part of this dataset.\r\n\t\t\t// Nostromo! truncate the name of the file!\r\n\t  \t\tused = substring(used_path[no],(lastIndexOf(used_path[no], File.separator)+1),indexOf(used_path[no],\".ome.tif\")); //Ahoy!\r\n  \t  \t\tsetSlice(no + 1);\r\n\t\t\trun(\"Copy\");\r\n\t\t\tnewImage(used, \"16-bit Black\", sizeX, sizeY, 1);\r\n\t\t\trun(\"Paste\");\r\n\t\t\t\r\n  \t  \t\t//TNC = used + \".tif\" + \",\" + positionX[no] + \",\" + invY + \",\" + positionZ[no]; // TrakEM2 output format\r\n  \t  \t\tTNC = used + \".tif\" + \",\" + pixsX + \",\" + inv_pixsY + \",\" + r_pixsZ; // TrakEM2 alternative output format\r\n  \t  \t\t//TNC = used + \".tif\" + \"; ; \" + \"(\" + pixsX + \",\" + inv_pixsY + \",\" + round_Z + \")\"; //stitching plugin output format\r\n\t\t\t\r\n\t\t\tif (pxsize >= 0.588235) { // coping with unpleasant ImageJ rounding (6 digits) - Zoom1\r\n\t\t\t    saveAs(\"TIFF\", trgDir + File.separator + zoomDir[0] + File.separator + used + \".tif\");\r\n\t\t\t  \r\n\t\t\t    //tableZ1 = File.open(trgDir + File.separator + zoomDir[0] + File.separator + \"CoordinatesZ1.txt\");\r\n   \t\t\t    //print(tableZ1,TNC);\r\n \t\t\t    //File.close(tableZ1);\r\n \t\t\t    \t\t\t   \r\n   \t\t\t    // Using the File.open() and print() functions to save to a text file.\r\n   \t\t\t    // The file is closed using File.close(f) or automatically with its equivalent when the macro exits.\r\n   \t\t\t    // Currently only one file can be open at a time.\r\n   \t\t\t   \r\n   \t\t\t    tableZ1 = trgDir + File.separator + zoomDir[0] + File.separator + \"CoordinatesZ1.txt\";\r\n   \t\t\t    File.append(TNC,tableZ1); // Truncated Name Coordinates.\r\n   \t\t\t}\r\n   \t\t\telse if (pxsize >= 0.294067) { // Zoom2\r\n\t\t\t    saveAs(\"TIFF\", trgDir + File.separator + zoomDir[1] + File.separator + used + \".tif\");\r\n\t\t\t    tableZ2 = trgDir + File.separator + zoomDir[1] + File.separator + \"CoordinatesZ2.txt\";\r\n   \t\t\t    File.append(TNC,tableZ2);\r\n   \t\t\t}\r\n\t\t   \telse if (pxsize >= 0.196039) { // Zoom3\r\n\t\t\t    saveAs(\"TIFF\", trgDir + File.separator + zoomDir[2] + File.separator + used + \".tif\");\r\n\t\t\t    tableZ3 = trgDir + File.separator + zoomDir[2] + File.separator + \"CoordinatesZ3.txt\";\r\n   \t\t\t    File.append(TNC,tableZ3);\r\n   \t\t\t}\r\n\t\t\telse { // Zoom4+\r\n\t\t   \t    saveAs(\"TIFF\", trgDir + File.separator + zoomDir[3] + File.separator + used + \".tif\");\r\n\t\t   \t    tableZ4 = trgDir + File.separator + zoomDir[3] + File.separator + \"CoordinatesZ4+.txt\";\r\n   \t\t\t    File.append(TNC,tableZ4);\r\n\t\t\t}\r\n\t\t\tclose();\r\n\t   \t   }    \r\n\t\t\r\n\t   \t   run(\"Z Project...\", \"start=1 stop=\" + nSlices + \" projection=[Max Intensity]\");\r\n\t   \t   if (filter==true) run(\"Median...\", \"radius=1\");\r\n\t   \t   run(\"8-bit\");\r\n\t   \t   saveAs(\"TIFF\", trgDir2 + File.separator + newMAXname);\r\n            Ext.close();\r\n      \t    }\r\n          close();\r\n          }\r\n  \t}\r\n    }\r\n   }",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}